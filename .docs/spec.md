# Fabric A4 排版工具規格書 (Specification)

## 1. 專案概述
本專案旨在開發一個基於 **Fabric.js v7.1.0** 的模組化 JavaScript 類別工具 (`FabricA4Layout`)。該工具在單一 Canvas 上模擬多頁 A4 排版，支援圖片拖曳、自訂控制項（內縮式設計）、版面流向切換（直向右排 / 橫向下排）以及完整的高解析度螢幕支援。

---

## 2. 技術堆疊
- **核心庫**: Fabric.js v7.1.0 (ESM)
- **語言**: JavaScript (ES6+ Class)
- **樣式**: SCSS (自定義 CSS Reset 與 Flexbox 佈局)
- **建置工具**: Vite
- **測試框架**: Vitest (可選整合)

---

## 3. 功能需求 (Functional Requirements)

### 3.1 初始化與配置 (Configuration)
`FabricA4Layout` 類別接受高彈性的配置參數：
- **Canvas ID**: 指定渲染的 DOM。
- **UI 綁定**: 支援 `buttons` 物件，可自訂綁定操作按鈕 ID (含更新圖片、清除畫布等)。
- **訊息顯示**: 支援 `statusDisplayId` 與 `errorDisplayId` 指定資訊渲染位置。
- **語系支援**: 支援 `locale` 物件，可自訂所有 UI 提示文字。
- **DPI 設定**: 預設 48，決定 A4 像素尺寸。
- **高解析度優化**: 強制設定 `enableRetinaScaling: false` 以確保版面座標精確性。
- **銷毀機制**: 提供 `destroy()` 方法以釋放資源並支援重新初始化。

### 3.2 版面流向引擎 (Layout Engine)
*   **頁面繪製**: 白色實心矩形 (`Rect`)，帶有邊框 (`stroke`) 以區分背景。
*   **座標系統**: 全域統一使用 `originX: 'left', originY: 'top'`。
*   **方向切換**: 
    - 直式 (Portrait): 頁面水平向右排列。
    - 橫式 (Landscape): 頁面垂直向下排列。
*   **動態頁數**: 支援 `addPage()` 與 `removePage()`。
    - **刪除頁面**: 移除最後一頁時，自動刪除該頁面範圍內的所有物件，並同步更新側邊欄狀態。

### 3.3 圖片管理 (Image Manager)
- **API**: 讀取符合 `API_SPEC.md` 的 JSON 格式。
- **側邊欄**: 動態渲染圖片列表，支援 Base64 與 URL 混合來源。
- **不重複限制**: 
    - 支援 `uniqueImages` 設定，防止圖片重複出現在畫布上。
    - **移除機制**: 在不重複模式下，點擊側邊欄已鎖定的圖片可觸發從畫布移除該圖片（防呆機制）。
    - **載入檢查**: 讀取佈局時若遇重複圖片，自動略過並回傳略過名單（顯示檔名）。
- **更新圖片**: 重新讀取 API，並自動清理畫布可視範圍外的「迷失」圖片。

### 3.4 自訂控制項 (Custom Controls)
針對每個圖片物件注入以下「內縮式 (Inset)」控制項：
- **旋轉按鈕 (TL)**: 左上角，順時針固定 90 度旋轉。
- **刪除按鈕 (TR)**: 右上角，內縮定位，防止邊緣切除。
- **灰階按鈕 (BL)**: 左下角，內縮定位，非同步濾鏡處理（帶有 `wait` 游標反饋）。
- **視覺強化**: 所有按鈕皆有實心底色，點擊區域擴大至 28x28 像素。

### 3.5 旋轉系統 (Rotation System)
- **演算法**: 中心點映射演算法 (Center-point Mapping)。
- **效果**: 模擬實體紙張旋轉，物件在旋轉後保持相對於紙張邊緣的正確視覺位置。

---

## 4. 資料結構 (Data Structures)

### 4.1 圖片列表 API
```json
{
  "status": "success",
  "data": [
    {
      "img_id": 101,
      "title": "...",
      "base64": "...",
      "url": "..."
    }
  ]
}
```

### 4.2 存檔與還原
- **座標轉換**: 存檔時自動將 Canvas 絕對座標轉換為「頁面相對座標」。
- **還原邏輯**: 根據 `imageId` 自動匹配 API 資料來源，支援過濾遺失圖片與重複圖片。
- **回傳值**: `load()` 方法回傳 `{ success, skipped }` 物件，供前端顯示略過訊息。