(function(v,g){typeof exports=="object"&&typeof module<"u"?g(exports,require("fabric")):typeof define=="function"&&define.amd?define(["exports","fabric"],g):(v=typeof globalThis<"u"?globalThis:v||self,g(v.FabricA4Layout={},v.fabric))})(this,(function(v,g){"use strict";const w={status:{setting:"設定:",dpi:"DPI",pages:"頁數:",orientation:"方向:",portrait:"直式",landscape:"橫式",size:"A4尺寸:",grayscale:"灰階預設:",on:"開啟",off:"關閉"},error:{fetchFailed:"API 讀取失敗",readError:"讀取圖片錯誤:",listUpdated:"圖片列表已更新，並已自動移除A4範圍外的圖片",canvasCleared:"A4已清空",noData:"無可讀取的佈局資料",skipped:"已略過重複圖片:",removedFromCanvas:"已從A4移除圖片"},confirm:{clearCanvas:"確定要清空A4上的所有圖片嗎？",removeImage:`此圖片已在A4上。是否要移除它？
(這能幫助您找回迷失的圖片)`}},z=(a,t,e,s,i)=>{a.save(),a.translate(t,e),a.rotate(g.util.degreesToRadians(i.angle)),a.beginPath(),a.arc(0,0,28/2,0,2*Math.PI,!1),a.fillStyle="white",a.fill(),a.shadowColor="rgba(0,0,0,0.2)",a.shadowBlur=4,a.fill(),a.beginPath(),a.arc(0,0,24/2,0,2*Math.PI,!1),a.fillStyle="#F44336",a.fill(),a.lineWidth=2,a.strokeStyle="white",a.beginPath(),a.moveTo(-24/4,-24/4),a.lineTo(24/4,24/4),a.moveTo(24/4,-24/4),a.lineTo(-24/4,24/4),a.stroke(),a.restore()},T=new g.Control({x:.5,y:-.5,offsetY:16,offsetX:-16,sizeX:28,sizeY:28,cursorStyle:"pointer",mouseUpHandler:(a,t)=>{const e=t.target,s=e.canvas;return s.remove(e),e.imageId&&s.fire("object:custom:delete",{target:e}),s.requestRenderAll(),!0},render:z}),B=(a,t,e,s,i)=>{a.save(),a.translate(t,e),a.rotate(g.util.degreesToRadians(i.angle)),a.beginPath(),a.arc(0,0,28/2,0,2*Math.PI,!1),a.fillStyle="white",a.fill(),a.shadowColor="rgba(0,0,0,0.2)",a.shadowBlur=4,a.fill(),a.beginPath(),a.arc(0,0,24/2,0,2*Math.PI,!1),a.fillStyle="white",a.fill(),a.lineWidth=1,a.strokeStyle="#333",a.stroke(),a.beginPath(),a.arc(0,0,24/2,-Math.PI/2,Math.PI/2,!1),a.fillStyle="black",a.fill(),a.restore()},j=new g.Control({x:-.5,y:.5,offsetY:-16,offsetX:16,sizeX:28,sizeY:28,cursorStyle:"pointer",mouseUpHandler:(a,t)=>{const e=t.target,s=e.canvas;return s.setCursor("wait"),setTimeout(()=>{e.filters.some(n=>n.type==="Grayscale")?e.filters=e.filters.filter(n=>n.type!=="Grayscale"):e.filters.push(new g.filters.Grayscale),e.applyFilters(),s.setCursor("default"),s.requestRenderAll()},50),!0},render:B}),H=(a,t,e,s,i)=>{a.save(),a.translate(t,e),a.rotate(g.util.degreesToRadians(i.angle)),a.beginPath(),a.arc(0,0,28/2,0,2*Math.PI,!1),a.fillStyle="white",a.fill(),a.shadowColor="rgba(0,0,0,0.2)",a.shadowBlur=4,a.fill(),a.strokeStyle="#2196F3",a.lineWidth=2,a.beginPath(),a.arc(0,0,24/4,0,Math.PI*1.5,!1),a.stroke(),a.fillStyle="#2196F3",a.beginPath(),a.moveTo(24/4,-24/8),a.lineTo(24/4+4,0),a.lineTo(24/4-4,0),a.fill(),a.restore()},W=new g.Control({x:-.5,y:-.5,offsetY:16,offsetX:16,sizeX:28,sizeY:28,cursorStyle:"crosshair",mouseUpHandler:(a,t)=>{const e=t.target,s=e.canvas,i=e.angle||0;return e.set("angle",(i+90)%360),e.setCoords(),s.requestRenderAll(),!0},render:H});class A{constructor(t){this.config={dpi:48,width:210,height:297,orientation:"portrait",saveWithBase64:!1,uniqueImages:!1,defaultGrayscale:!1,saveEndpoint:null,data:{},buttons:{},statusDisplayId:null,errorDisplayId:null,locale:{},...t},this.t={status:{...w.status,...this.config.locale?.status||{}},error:{...w.error,...this.config.locale?.error||{}},confirm:{...w.confirm,...this.config.locale?.confirm||{}}},this.config.dpi<24&&(this.config.dpi=24),this.config.dpi>192&&(this.config.dpi=192);const e=s=>Math.round(s/25.4*this.config.dpi);this.pageWidthPx=e(this.config.width),this.pageHeightPx=e(this.config.height),this.gap=4,this.canvasId=this.config.canvasId,this.canvas=null,this.images=[],this.pageCount=1,this.orientation=this.config.orientation}async init(){this.canvas=new g.Canvas(this.canvasId,{preserveObjectStacking:!0,selection:!0,enableRetinaScaling:!1}),this.setupLayout(),await this.fetchImages(),this.setupEvents(),this.bindControls(),this.updateStatusDisplay()}bindControls(){const t=this.config.buttons,e=(s,i)=>{if(s){const n=document.getElementById(s);if(n){const o=n.cloneNode(!0);n.parentNode.replaceChild(o,n),o.onclick=i}}};if(e(t.orientation,()=>{this.toggleOrientation(),this.updateStatusDisplay()}),e(t.addPage,()=>{this.addPage(),this.updateStatusDisplay()}),e(t.removePage,()=>{this.removePage(),this.updateStatusDisplay()}),e(t.refreshImages,async()=>{this.cleanupOutOfBounds(),await this.fetchImages(),this.showError(this.t.error.listUpdated,!0)}),e(t.clearCanvas,()=>{confirm(this.t.confirm.clearCanvas)&&(this.clearCanvas(),this.showError(this.t.error.canvasCleared,!0))}),t.save){const s=document.getElementById(t.save);if(s){const i=s.cloneNode(!0);s.parentNode.replaceChild(i,s),i.onclick=()=>{const n=this.save();this.config.onSave&&this.config.onSave(n)}}}if(t.load){const s=document.getElementById(t.load);if(s){const i=s.cloneNode(!0);s.parentNode.replaceChild(i,s),i.onclick=async()=>{let n=null;if(this.config.onLoad&&(n=this.config.onLoad()),n){const o=await this.load(n);this.updateStatusDisplay(),o.skipped&&o.skipped.length>0&&this.showError(`${this.t.error.skipped} ${o.skipped.join(", ")}`)}else this.showError(this.t.error.noData)}}}if(t.settings&&this.config.onSettingsClick){const s=document.getElementById(t.settings);if(s){const i=s.cloneNode(!0);s.parentNode.replaceChild(i,s),i.onclick=this.config.onSettingsClick}}}showError(t,e=!1){if(this.config.errorDisplayId){const s=document.getElementById(this.config.errorDisplayId);s&&(s.style.display="block",s.innerText=t,s.style.backgroundColor=e?"#e8f5e9":"#ffebee",s.style.color=e?"#2e7d32":"#c62828",s.style.borderColor=e?"#a5d6a7":"#ef9a9a",setTimeout(()=>{s.style.display="none"},5e3))}else console.log(e?"Info:":"Error:",t),e||alert(t)}updateStatusDisplay(){if(this.config.statusDisplayId){const t=document.getElementById(this.config.statusDisplayId);if(t&&this.canvas){const e=this.canvas.getWidth(),s=this.canvas.getHeight(),i=this.orientation==="portrait"?this.t.status.portrait:this.t.status.landscape;t.innerHTML=`
                <strong>${this.t.status.setting}</strong> ${this.t.status.dpi} ${this.config.dpi} | 
                <strong>${this.t.status.pages}</strong> ${this.pageCount} | 
                <strong>${this.t.status.orientation}</strong> ${i} | 
                <strong>${this.t.status.size}</strong> ${e} x ${s} px |
                <strong>${this.t.status.grayscale}</strong> ${this.config.defaultGrayscale?this.t.status.on:this.t.status.off}
            `}}}async fetchImages(){try{const t=await fetch(this.config.apiEndpoint);if(!t.ok)throw new Error(this.t.error.fetchFailed);const e=await t.json();if(e.succ===!1)throw new Error(e.error||this.t.error.fetchFailed);this.images=e.data||[],this.renderSidebar()}catch(t){console.error(this.t.error.readError,t),this.showError(`${this.t.error.fetchFailed}: ${t.message}`),this.images=[],this.renderSidebar()}}renderSidebar(){const t=document.getElementById("image-sidebar");t&&(t.innerHTML="",this.images.forEach(e=>{const s=document.createElement("div");s.className="image-item",s.dataset.id=e.img_id;const i=this.config.uniqueImages&&this.isImageOnCanvas(e.img_id);s.onclick=()=>{i?confirm(this.t.confirm.removeImage)&&(this.canvas.getObjects().filter(d=>d.imageId===e.img_id).forEach(d=>this.canvas.remove(d)),this.updateSidebarStatus(e.img_id,!1),this.showError(this.t.error.removedFromCanvas,!0)):this.addImageToCanvas(e.img_id)},i&&(s.classList.add("disabled"),s.title="已在A4上 (點擊可移除)",s.style.cursor="help");const n=document.createElement("img");n.src=e.url||e.base64,n.draggable=!1;const o=document.createElement("span");o.className="label",o.innerText=e.title||e.img_id,s.appendChild(n),s.appendChild(o),t.appendChild(s)}))}isImageOnCanvas(t){return this.canvas.getObjects().some(e=>e.imageId===t)}updateSidebarStatus(t,e){this.config.uniqueImages&&this.renderSidebar()}async addImageToCanvas(t){if(this.config.uniqueImages&&this.isImageOnCanvas(t))return;const e=this.images.find(u=>u.img_id===t);if(!e)return;const s=e.url||e.base64,i=await g.FabricImage.fromURL(s);i.set({imageId:t,cornerSize:10,transparentCorners:!1,originX:"left",originY:"top"});const o=this.config.dpi/96;let h=1,d=1;e.original_width&&e.original_height&&i.width>0&&i.height>0?(h=e.original_width/i.width*o,d=e.original_height/i.height*o):(h=o,d=o),i.scaleX=h,i.scaleY=d,this.config.defaultGrayscale&&(i.filters.push(new g.filters.Grayscale),i.applyFilters()),this.setupCustomControls(i);const c=this.orientation==="portrait",l=c?this.pageWidthPx:this.pageHeightPx,r=c?this.pageHeightPx:this.pageWidthPx;if(i.getScaledWidth()>l||i.getScaledHeight()>r){const u=Math.min(l/i.getScaledWidth(),r/i.getScaledHeight())*.95;i.scaleX*=u,i.scaleY*=u}let f=this.pageCount-1;const S=(u=>this.canvas.getObjects().filter(m=>!m.isBackground).filter(m=>{const C=m.getCenterPoint();if(c){const b=u*(l+this.gap),O=b+l;return C.x>=b&&C.x<O}else{const b=u*(r+this.gap),O=b+r;return C.y>=b&&C.y<O}}))(f);let y=0;const k=r*.025;if(S.length>0){let u=0;S.forEach(I=>{let m=0;if(c)m=I.top+I.getScaledHeight();else{const C=f*(r+this.gap);m=I.top-C+I.getScaledHeight()}m>u&&(u=m)}),y=u+this.gap}else y=k;y+i.getScaledHeight()>r&&(this.addPage(),f++,y=k);let P,E;if(c)P=f*(l+this.gap)+(l-i.getScaledWidth())/2,E=y;else{const u=f*(r+this.gap);P=(l-i.getScaledWidth())/2,E=u+y}i.set({left:P,top:E}),this.canvas.add(i),this.canvas.setActiveObject(i),this.updateSidebarStatus(t,!0)}setupCustomControls(t){delete t.controls.ml,delete t.controls.mr,delete t.controls.mt,delete t.controls.mb,delete t.controls.mtr,t.controls.deleteControl=T,t.controls.grayscaleControl=j,t.controls.rotate90Control=W}setupLayout(){let t,e;const s=this.canvas.getObjects().filter(i=>i.isBackground);if(this.canvas.remove(...s),this.orientation==="portrait"){const i=this.pageWidthPx,n=this.pageHeightPx;e=n,t=(i+this.gap)*this.pageCount-this.gap,this.canvas.setDimensions({width:t,height:e},{cssOnly:!1,backstoreOnly:!1});for(let o=0;o<this.pageCount;o++){const h=new g.Rect({left:o*(i+this.gap),top:0,width:i,height:n,fill:"white",stroke:"#999",strokeWidth:1,selectable:!1,evented:!1,isBackground:!0,hoverCursor:"default",originX:"left",originY:"top"});this.canvas.add(h),this.canvas.sendObjectToBack(h)}}else{const i=this.pageHeightPx,n=this.pageWidthPx;t=i,e=(n+this.gap)*this.pageCount-this.gap,this.canvas.setDimensions({width:t,height:e},{cssOnly:!1,backstoreOnly:!1});for(let o=0;o<this.pageCount;o++){const h=new g.Rect({left:0,top:o*(n+this.gap),width:i,height:n,fill:"white",stroke:"#999",strokeWidth:1,selectable:!1,evented:!1,isBackground:!0,hoverCursor:"default",originX:"left",originY:"top"});this.canvas.add(h),this.canvas.sendObjectToBack(h)}}this.canvas.calcOffset(),this.canvas.requestRenderAll()}toggleOrientation(){const t=this.orientation;this.orientation=t==="portrait"?"landscape":"portrait",this.canvas.getObjects().filter(s=>!s.isBackground).forEach(s=>{const i=s.getCenterPoint();let n=0,o=0,h=0;const d=this.pageWidthPx,c=this.pageHeightPx;if(t==="portrait")n=Math.floor(i.x/(d+this.gap)),o=i.x-n*(d+this.gap),h=i.y;else{const S=d;n=Math.floor(i.y/(S+this.gap)),o=i.x,h=i.y-n*(S+this.gap)}let l,r;t==="portrait"?(l=c-h,r=o,s.angle=(s.angle||0)+90):(l=h,r=c-o,s.angle=(s.angle||0)-90);let f,p;this.orientation==="portrait"?(f=n*(d+this.gap)+l,p=r):(f=l,p=n*(d+this.gap)+r),s.setPositionByOrigin(new g.Point(f,p),"center","center"),s.setCoords()}),this.setupLayout()}setupEvents(){this.canvas.on("object:custom:delete",t=>{t.target&&t.target.imageId&&this.updateSidebarStatus(t.target.imageId,!1)})}save(t={}){const e=this.canvas.toObject(["imageId","id"]);return e.objects=e.objects.filter(s=>!s.isBackground),this.config.saveWithBase64||e.objects.forEach(s=>{s.type==="image"&&delete s.src}),{version:"1.0",timestamp:Date.now(),orientation:this.orientation,pageCount:this.pageCount,dpi:this.config.dpi,canvasObjects:e.objects,data:{...this.config.data,...t}}}async saveToBackend(t={}){const e=this.save(t);if(!this.config.saveEndpoint)throw new Error("No saveEndpoint configured.");try{const s=await fetch(this.config.saveEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const i=await s.json();if(i.succ===!1)throw new Error(i.error||"Server reported failure.");return i}catch(s){throw console.error("Save failed:",s),s}}async load(t){if(!t)return{success:!1,message:"No data"};let e=t;if("succ"in t){if(t.succ===!1)return{success:!1,message:t.error||"Unknown error from API data"};t.data&&(e=t.data)}const s=e;this.canvas.clear(),this.orientation=s.orientation||"portrait",this.pageCount=s.pageCount||1,this.setupLayout();const i=s.canvasObjects||[],n=new Set,o=[],h=s.dpi||this.config.dpi,d=this.config.dpi/h;for(const c of i){if(this.config.uniqueImages&&n.has(c.imageId)){const r=this.images.find(p=>p.img_id===c.imageId),f=r?r.title||r.img_id:c.imageId;o.push(f);continue}const l=this.images.find(r=>r.img_id===c.imageId);if(l){n.add(c.imageId);const r={...c};Math.abs(d-1)>1e-4&&(r.left*=d,r.top*=d,r.scaleX=(r.scaleX||1)*d,r.scaleY=(r.scaleY||1)*d);const f=l.url||l.base64,p=await g.FabricImage.fromURL(f);p.set(r),p.set({src:f}),c.filters&&c.filters.length>0&&p.applyFilters(),this.setupCustomControls(p),this.canvas.add(p),this.updateSidebarStatus(c.imageId,!0)}else console.warn(`Image ID ${c.imageId} not found in API. Skipping.`)}return this.canvas.requestRenderAll(),{success:!0,skipped:o}}addPage(){this.pageCount++,this.setupLayout()}removePage(){if(this.pageCount>1){const t=this.pageWidthPx,e=this.pageHeightPx,s=this.pageCount-1;let i,n,o,h;if(this.orientation==="portrait")i=s*(t+this.gap),n=0,o=t,h=e;else{const l=e,r=t;i=0,n=s*(r+this.gap),o=l,h=r}const d=this.canvas.getObjects().filter(l=>!l.isBackground),c=[];d.forEach(l=>{const r=l.getCenterPoint();r.x>=i&&r.x<=i+o&&r.y>=n&&r.y<=n+h&&c.push(l)}),c.forEach(l=>{l.imageId&&this.updateSidebarStatus(l.imageId,!1),this.canvas.remove(l)}),this.pageCount--,this.setupLayout()}}enforceUniqueness(){if(!this.config.uniqueImages)return;const t=this.canvas.getObjects().filter(i=>!i.isBackground),e=new Set,s=[];return t.forEach(i=>{i.imageId&&(e.has(i.imageId)?s.push(i):e.add(i.imageId))}),s.forEach(i=>{this.canvas.remove(i)}),this.canvas.requestRenderAll(),s.length}cleanupOutOfBounds(){const t=this.canvas.getObjects().filter(i=>!i.isBackground),e=this.canvas.getWidth(),s=this.canvas.getHeight();t.forEach(i=>{const n=i.getCenterPoint();(n.x<-50||n.x>e+50||n.y<-50||n.y>s+50)&&(this.canvas.remove(i),i.imageId&&this.updateSidebarStatus(i.imageId,!1))}),this.canvas.requestRenderAll()}clearCanvas(){this.canvas.getObjects().filter(e=>!e.isBackground).forEach(e=>{this.canvas.remove(e),e.imageId&&this.updateSidebarStatus(e.imageId,!1)}),this.canvas.requestRenderAll()}destroy(){this.canvas&&(this.canvas.dispose(),this.canvas=null)}}v.FabricA4Layout=A,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})}));
