<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric.js A4 æ’ç‰ˆç³»çµ±ç¯„ä¾‹</title>
    <!-- In development, we use the source SCSS (Vite handles it) -->
    <!-- In production, this would be <link rel="stylesheet" href="dist/css/fabric.FabricA4Layout.min.css"> -->
</head>
<body>
    <div id="app">
        <div style="padding: 10px; background: #eee; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <strong>åŠŸèƒ½æ§åˆ¶:</strong>
            <button id="btn-orientation">åˆ‡æ›ç‰ˆé¢æ–¹å‘ (ç›´/æ©«)</button>
            <button id="btn-add-page">å¢åŠ é æ•¸</button>
            <button id="btn-remove-page">æ¸›å°‘é æ•¸</button>
            <button id="btn-refresh-images">ğŸ”„ æ›´æ–°åœ–ç‰‡</button>
            <button id="btn-settings">âš™ï¸ ç•«å¸ƒè¨­å®š</button>
            <button id="btn-save">å„²å­˜ä½ˆå±€ (çœ‹ Console)</button>
            <button id="btn-load">è®€å–ä½ˆå±€</button>
            
            <span id="status-display" style="margin-left: auto; font-size: 14px; color: #555; background: #fff; padding: 2px 8px; border-radius: 4px; border: 1px solid #ddd;">
                è¼‰å…¥ä¸­...
            </span>
        </div>
        
        <!-- Error Display Container -->
        <div id="error-display" style="display: none; background: #ffebee; color: #c62828; padding: 10px; border-bottom: 1px solid #ef9a9a; font-size: 14px;"></div>

        <dialog id="settings-dialog" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <form method="dialog">
                <h3 style="margin-top: 0;">ç•«å¸ƒåˆå§‹è¨­å®š</h3>
                <div style="margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px;">
                    <label>
                        DPI è¨­å®š:
                        <input type="number" id="inp-dpi" value="48" min="24" max="192" style="width: 80px;">
                    </label>
                    <label>
                        A4 çŸ­é‚Šåƒç´  (px):
                        <input type="number" id="inp-px" value="397" style="width: 80px;">
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
                        <input type="checkbox" id="inp-unique">
                        å•Ÿç”¨åœ–ç‰‡ä¸é‡è¤‡é™åˆ¶
                    </label>
                    <small style="color: #666; margin-top: 5px;">æ³¨æ„ï¼šå¥—ç”¨è¨­å®šå°‡æœƒ<b>æ¸…ç©ºä¸¦é‡ç½®</b>ç›®å‰ç•«å¸ƒã€‚</small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="btn-cancel-settings">å–æ¶ˆ</button>
                    <button type="button" id="btn-apply-settings" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">å¥—ç”¨ä¸¦é‡ç½®</button>
                </div>
            </form>
        </dialog>

        <div class="layout-container">
            <!-- Sidebar -->
            <div id="image-sidebar" class="sidebar">
                è¼‰å…¥åœ–ç‰‡ä¸­...
            </div>
            
            <!-- Canvas -->
            <div class="canvas-wrapper">
                <canvas id="c"></canvas>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script type="module">
        import { FabricA4Layout } from './src/js/fabric.FabricA4Layout.js';
        import './src/scss/fabric.FabricA4Layout.scss';

        // Global reference
        window.layout = null;
        let lastSavedData = null;

        // --- Settings Modal Logic (Decoupled from Layout Class for now, or could be integrated) ---
        // For flexibility, keeping Settings Modal UI logic external is fine, 
        // but the 'Apply' action will call layout methods.
        const dialog = document.getElementById('settings-dialog');
        const inpDpi = document.getElementById('inp-dpi');
        const inpPx = document.getElementById('inp-px');
        const inpUnique = document.getElementById('inp-unique');
        const mmShort = 210;

        inpDpi.oninput = () => {
            const dpi = parseInt(inpDpi.value) || 0;
            if (dpi > 0) inpPx.value = Math.round((mmShort / 25.4) * dpi);
        };
        inpPx.oninput = () => {
            const px = parseInt(inpPx.value) || 0;
            if (px > 0) inpDpi.value = Math.round((px * 25.4) / mmShort);
        };

        document.getElementById('btn-cancel-settings').onclick = () => dialog.close();
        
        // This button needs access to current config to trigger update
        document.getElementById('btn-apply-settings').onclick = () => {
            if (!window.layout) return;
            
            const newDpi = parseInt(inpDpi.value) || 48;
            const newUnique = inpUnique.checked;
            dialog.close();

            // Re-initialize with new settings (merging with old config is handled by createLayout wrapper)
            // But here we need to call a layout method or helper.
            // Let's use the helper `createLayout` again.
            
            const newConfig = {
                ...window.layout.config,
                dpi: newDpi,
                uniqueImages: newUnique
            };
            createLayout(newConfig);
        };

        // --- Layout Initialization Helper ---
        async function createLayout(config) {
            // Cleanup
            if (window.layout) {
                window.layout.destroy();
                window.layout = null;
            }

            // Ensure Canvas
            let c = document.getElementById(config.canvasId);
            if (!c) {
                const wrapper = document.querySelector('.canvas-wrapper');
                c = document.createElement('canvas');
                c.id = config.canvasId;
                wrapper.appendChild(c);
            }

            // Init
            const layout = new FabricA4Layout(config);
            window.layout = layout;
            await layout.init();
        }

        // --- Main Entry ---
        async function init() {
            const config = {
                canvasId: 'c',
                orientation: 'portrait',
                apiEndpoint: './api/images.json',
                uniqueImages: false,
                dpi: 48,
                
                // New: Bind DOM IDs
                statusDisplayId: 'status-display',
                errorDisplayId: 'error-display',
                buttons: {
                    orientation: 'btn-orientation',
                    addPage: 'btn-add-page',
                    removePage: 'btn-remove-page',
                    save: 'btn-save',
                    load: 'btn-load',
                    refreshImages: 'btn-refresh-images',
                    settings: 'btn-settings' // We will hook this to open the modal
                },
                
                // Custom Hooks (Optional)
                onSave: (data) => {
                    console.log('Saved Data:', data);
                    lastSavedData = data;
                    // Note: Success message logic moved inside class via showError/showStatus? 
                    // Or keep alerts? The prompt asks for "error message block ID", implying UI display.
                    alert('ä½ˆå±€å·²å„²å­˜ (Memory & Console)'); 
                },
                onLoad: (data) => {
                    return lastSavedData; // The class calls this to get data? No, usually buttons trigger class methods.
                    // The class will bind click events. The Load button needs data.
                    // Implementation Detail: The class binding for 'load' usually expects the data source.
                    // We can pass a data getter?
                },
                onSettingsClick: () => {
                    // Pre-fill modal
                    inpDpi.value = window.layout.config.dpi;
                    inpUnique.checked = window.layout.config.uniqueImages;
                    inpDpi.dispatchEvent(new Event('input'));
                    dialog.showModal();
                }
            };

            await createLayout(config);
        }

        init();
    </script>
</body>
</html>
            <!-- Sidebar -->
            <div id="image-sidebar" class="sidebar">
                è¼‰å…¥åœ–ç‰‡ä¸­...
            </div>
            
            <!-- Canvas -->
            <div class="canvas-wrapper">
                <canvas id="c"></canvas>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script type="module">
        // Import our class. In Vite dev, this works directly.
        import { FabricA4Layout } from './src/js/fabric.FabricA4Layout.js';
        import './src/scss/fabric.FabricA4Layout.scss';

        // Mock Save Data storage
        let lastSavedData = null;

        function updateStatusDisplay(layout) {
            const el = document.getElementById('status-display');
            if (!layout || !layout.canvas) return;
            
            const totalW = layout.canvas.getWidth();
            const totalH = layout.canvas.getHeight();
            
            el.innerHTML = `
                <strong>è¨­å®š:</strong> DPI ${layout.config.dpi} | 
                <strong>é æ•¸:</strong> ${layout.pageCount} | 
                <strong>æ–¹å‘:</strong> ${layout.orientation === 'portrait' ? 'ç›´å¼' : 'æ©«å¼'} | 
                <strong>ç•«å¸ƒå°ºå¯¸:</strong> ${totalW} x ${totalH} px
            `;
        }

        async function createLayout(config) {
            // 1. Cleanup old instance
            if (window.layout) {
                window.layout.destroy();
                window.layout = null;
            }

            // 2. Ensure Canvas Element exists (Fabric dispose might remove wrapper but we need the element)
            let c = document.getElementById('c');
            if (!c) {
                const wrapper = document.querySelector('.canvas-wrapper');
                c = document.createElement('canvas');
                c.id = 'c';
                wrapper.appendChild(c);
            }

            // 3. Create new instance
            const layout = new FabricA4Layout(config);
            window.layout = layout; 
            await layout.init();
            updateStatusDisplay(layout);
            return layout;
        }

        async function init() {
            let currentConfig = {
                canvasId: 'c',
                orientation: 'portrait',
                apiEndpoint: './api/images.json', 
                uniqueImages: false,
                dpi: 48 
            };

            await createLayout(currentConfig);

            // Settings Logic
            const dialog = document.getElementById('settings-dialog');
            const inpDpi = document.getElementById('inp-dpi');
            const inpPx = document.getElementById('inp-px');
            const inpUnique = document.getElementById('inp-unique');

            // Sync Logic
            const mmShort = 210;
            inpDpi.oninput = () => {
                const dpi = parseInt(inpDpi.value) || 0;
                if (dpi > 0) inpPx.value = Math.round((mmShort / 25.4) * dpi);
            };
            inpPx.oninput = () => {
                const px = parseInt(inpPx.value) || 0;
                if (px > 0) inpDpi.value = Math.round((px * 25.4) / mmShort);
            };

            document.getElementById('btn-settings').onclick = () => {
                // Load current values
                inpDpi.value = window.layout.config.dpi;
                inpUnique.checked = window.layout.config.uniqueImages;
                inpDpi.dispatchEvent(new Event('input')); // trigger sync
                dialog.showModal();
            };

            document.getElementById('btn-cancel-settings').onclick = () => dialog.close();

            document.getElementById('btn-apply-settings').onclick = async () => {
                const newDpi = parseInt(inpDpi.value) || 48;
                const newUnique = inpUnique.checked;
                dialog.close();
                
                // Update Config
                currentConfig = {
                    ...currentConfig,
                    dpi: newDpi,
                    uniqueImages: newUnique
                };

                // Re-init
                await createLayout(currentConfig);
                alert(`ç•«å¸ƒå·²é‡ç½®ï¼\nDPI: ${newDpi}\nä¸é‡è¤‡é™åˆ¶: ${newUnique ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
            };

            // Bind Buttons
            document.getElementById('btn-orientation').onclick = () => {
                window.layout.toggleOrientation();
                updateStatusDisplay(window.layout);
            };

            document.getElementById('btn-add-page').onclick = () => {
                window.layout.addPage();
                updateStatusDisplay(window.layout);
            };

            document.getElementById('btn-remove-page').onclick = () => {
                window.layout.removePage();
                updateStatusDisplay(window.layout);
            };

            document.getElementById('btn-save').onclick = () => {
                const data = window.layout.save({ demo_user: 'user_123' });
                console.log('Saved Data:', data);
                lastSavedData = data;
                alert('ä½ˆå±€å·²å„²å­˜ (è«‹çœ‹ Console F12)ï¼ä¸¦å·²æš«å­˜æ–¼è¨˜æ†¶é«”ä¸­ã€‚');
            };

            document.getElementById('btn-load').onclick = async () => {
                if (lastSavedData) {
                    const result = await window.layout.load(lastSavedData);
                    updateStatusDisplay(window.layout);
                    
                    if (result.skipped && result.skipped.length > 0) {
                        alert(`ä½ˆå±€è®€å–æˆåŠŸï¼\n\næ³¨æ„ï¼šæ ¹æ“šã€Œåœ–ç‰‡ä¸é‡è¤‡é™åˆ¶ã€ï¼Œå·²è‡ªå‹•ç§»é™¤ ${result.skipped.length} å¼µé‡è¤‡çš„åœ–ç‰‡ã€‚\n(æª”å: ${result.skipped.join(', ')})`);
                    } else {
                        alert('ä½ˆå±€è®€å–æˆåŠŸï¼');
                    }
                } else {
                    alert('å°šæœªå„²å­˜ä»»ä½•ä½ˆå±€ï¼è«‹å…ˆè©¦è‘—æ“ºæ”¾åœ–ç‰‡ä¸¦å„²å­˜ã€‚');
                }
            };
        }
    </script>
</body>
</html>