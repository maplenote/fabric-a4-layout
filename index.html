<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric.js A4 æ’ç‰ˆç³»çµ±ç¯„ä¾‹</title>
    <!-- In development, we use the source SCSS (Vite handles it) -->
    <!-- In production, this would be <link rel="stylesheet" href="dist/css/fabric.FabricA4Layout.min.css"> -->
</head>
<body>
    <div id="app">
        <div style="padding: 10px; background: #eee; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <strong>åŠŸèƒ½æ§åˆ¶:</strong>
            <button id="btn-orientation">åˆ‡æ›ç‰ˆé¢æ–¹å‘ (ç›´/æ©«)</button>
            <button id="btn-add-page">å¢åŠ é æ•¸</button>
            <button id="btn-remove-page">æ¸›å°‘é æ•¸</button>
            <button id="btn-refresh-images">ğŸ”„ æ›´æ–°åœ–ç‰‡</button>
            <button id="btn-settings">âš™ï¸ A4è¨­å®š</button>
            <button id="btn-save">å„²å­˜ä½ˆå±€ (çœ‹ Console)</button>
            <button id="btn-load">è®€å–ä½ˆå±€</button>
            
            <span id="status-display" style="margin-left: auto; font-size: 14px; color: #555; background: #fff; padding: 2px 8px; border-radius: 4px; border: 1px solid #ddd;">
                è¼‰å…¥ä¸­...
            </span>
        </div>
        
        <!-- Error Display Container -->
        <div id="error-display" style="display: none; background: #ffebee; color: #c62828; padding: 10px; border-bottom: 1px solid #ef9a9a; font-size: 14px;"></div>

        <dialog id="settings-dialog" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <form method="dialog">
                <h3 style="margin-top: 0;">A4åˆå§‹è¨­å®š</h3>
                <div style="margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px;">
                    <label>
                        DPI è¨­å®š:
                        <input type="number" id="inp-dpi" value="48" min="24" max="192" style="width: 80px;">
                    </label>
                    <label>
                        A4 çŸ­é‚Šåƒç´  (px):
                        <input type="number" id="inp-px" value="397" style="width: 80px;">
                    </label>
                    <label>
                        é è¨­æ–¹å‘:
                        <select id="inp-orientation" style="padding: 2px;">
                            <option value="portrait">ç›´å¼ (Portrait)</option>
                            <option value="landscape">æ©«å¼ (Landscape)</option>
                        </select>
                    </label>
                    <label style="display: flex; flex-direction: column; gap: 5px;">
                        è‡ªè¨‚ Data (JSON):
                        <textarea id="inp-data" rows="3" style="width: 100%; font-family: monospace; font-size: 12px; padding: 5px;" placeholder='{"key": "value"}'></textarea>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
                        <input type="checkbox" id="inp-unique">
                        å•Ÿç”¨åœ–ç‰‡ä¸é‡è¤‡é™åˆ¶
                    </label>
                    <small style="color: #666; margin-top: 5px;">æ³¨æ„ï¼šå¥—ç”¨è¨­å®šå°‡æœƒ<b>æ¸…ç©ºä¸¦é‡ç½®</b>ç›®å‰A4ã€‚</small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="btn-cancel-settings">å–æ¶ˆ</button>
                    <button type="button" id="btn-apply-settings" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">å¥—ç”¨ä¸¦é‡ç½®</button>
                </div>
            </form>
        </dialog>

        <div class="layout-container">
            <!-- Sidebar -->
            <div id="image-sidebar" class="sidebar">
                è¼‰å…¥åœ–ç‰‡ä¸­...
            </div>
            
            <!-- Canvas -->
            <div class="canvas-wrapper">
                <canvas id="c"></canvas>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script type="module">
        import { FabricA4Layout } from './src/js/fabric.FabricA4Layout.js';
        import './src/scss/fabric.FabricA4Layout.scss';

        // Global reference
        window.layout = null;
        let lastSavedData = null;

        function updateStatusDisplay(layout) {
            const el = document.getElementById('status-display');
            if (!layout || !layout.canvas) return;
            
            const totalW = layout.canvas.getWidth();
            const totalH = layout.canvas.getHeight();
            
            el.innerHTML = `
                <strong>è¨­å®š:</strong> DPI ${layout.config.dpi} |
                <strong>é æ•¸:</strong> ${layout.pageCount} |
                <strong>æ–¹å‘:</strong> ${layout.orientation === 'portrait' ? 'ç›´å¼' : 'æ©«å¼'} |
                <strong>A4å°ºå¯¸:</strong> ${totalW} x ${totalH} px
            `;
        }

        // --- Layout Initialization Helper ---
        async function createLayout(config) {
            // Cleanup
            if (window.layout) {
                window.layout.destroy();
                window.layout = null;
            }

            // Ensure Canvas
            let c = document.getElementById(config.canvasId);
            if (!c) {
                const wrapper = document.querySelector('.canvas-wrapper');
                c = document.createElement('canvas');
                c.id = config.canvasId;
                wrapper.appendChild(c);
            }

            // Init
            const layout = new FabricA4Layout(config);
            window.layout = layout;
            await layout.init();
            updateStatusDisplay(layout);
        }

        // --- Main Entry ---
        async function init() {
            let currentConfig = {
                canvasId: 'c',
                orientation: 'portrait',
                apiEndpoint: './api/images.json',
                // saveEndpoint: '/api/save',
                uniqueImages: false,
                dpi: 48,
                data: { "page_pk": "123", "user_note": "Demo Note" }
            };

            await createLayout(currentConfig);

            // Settings Logic
            const dialog = document.getElementById('settings-dialog');
            const inpDpi = document.getElementById('inp-dpi');
            const inpPx = document.getElementById('inp-px');
            const inpUnique = document.getElementById('inp-unique');
            const inpOrientation = document.getElementById('inp-orientation');
            const inpData = document.getElementById('inp-data');
            const mmShort = 210;

            inpDpi.oninput = () => {
                const dpi = parseInt(inpDpi.value) || 0;
                if (dpi > 0) inpPx.value = Math.round((mmShort / 25.4) * dpi);
            };
            inpPx.oninput = () => {
                const px = parseInt(inpPx.value) || 0;
                if (px > 0) inpDpi.value = Math.round((px * 25.4) / mmShort);
            };

            document.getElementById('btn-cancel-settings').onclick = () => dialog.close();

            document.getElementById('btn-settings').onclick = () => {
                // Load current values
                inpDpi.value = window.layout.config.dpi;
                inpUnique.checked = window.layout.config.uniqueImages;
                // Use current actual orientation
                inpOrientation.value = window.layout.orientation || 'portrait';
                // Load current data
                inpData.value = JSON.stringify(window.layout.config.data || {}, null, 2);
                
                inpDpi.dispatchEvent(new Event('input')); // trigger sync
                dialog.showModal();
            };

            document.getElementById('btn-apply-settings').onclick = async () => {
                const newDpi = parseInt(inpDpi.value) || 48;
                const newUnique = inpUnique.checked;
                const newOrientation = inpOrientation.value;
                
                let newData = {};
                try {
                    newData = JSON.parse(inpData.value || '{}');
                } catch (e) {
                    alert('JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è‡ªè¨‚ Data å…§å®¹ï¼');
                    return;
                }

                dialog.close();
                
                // Update Config
                currentConfig = {
                    ...currentConfig,
                    dpi: newDpi,
                    uniqueImages: newUnique,
                    orientation: newOrientation,
                    data: newData
                };

                // Re-init
                await createLayout(currentConfig);
                alert(`A4å·²é‡ç½®ï¼\nDPI: ${newDpi}\næ–¹å‘: ${newOrientation}\nä¸é‡è¤‡é™åˆ¶: ${newUnique ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
            };

             // Bind Buttons
            document.getElementById('btn-orientation').onclick = () => {
                window.layout.toggleOrientation();
                updateStatusDisplay(window.layout);
            };

            document.getElementById('btn-add-page').onclick = () => {
                window.layout.addPage();
                updateStatusDisplay(window.layout);
            };

            document.getElementById('btn-remove-page').onclick = () => {
                window.layout.removePage();
                updateStatusDisplay(window.layout);
            };
            
            document.getElementById('btn-refresh-images').onclick = () => {
                 // Manual refresh trigger if needed, though class binds it too if ID passed.
                 // But wait, the class bindControls uses 'buttons' config. 
                 // We should probably rely on class binding OR manual binding.
                 // In this file, I see manual bindings below. 
                 // The class also binds if IDs match. 
                 // Let's keep manual bindings for safety as they are explicit here.
                 window.layout.cleanupOutOfBounds(); 
                 window.layout.fetchImages().then(() => alert('åœ–ç‰‡åˆ—è¡¨å·²æ›´æ–°'));
            };

            document.getElementById('btn-save').onclick = async () => {
                if (window.layout.config.saveEndpoint) {
                    try {
                        const res = await window.layout.saveToBackend({ demo_user: 'user_123' });
                        alert('ä½ˆå±€å·²æˆåŠŸå„²å­˜è‡³ä¼ºæœå™¨ï¼');
                        console.log('Server Response:', res);
                        return;
                    } catch (e) {
                        console.warn('Backend save failed (Demo mode?), falling back to console.', e);
                        alert(`å¾Œç«¯å„²å­˜å¤±æ•— (å¯èƒ½æ˜¯ Demo ç„¡çœŸå¯¦ API): ${e.message}\n\nè³‡æ–™å°‡é¡¯ç¤ºæ–¼ Consoleã€‚`);
                    }
                } else {
                    console.log('No saveEndpoint configured. Using Console mode.');
                }

                const data = window.layout.save({ demo_user: 'user_123' });
                console.log('Saved Data (Console Mode):', data);
                lastSavedData = data;
                if (!window.layout.config.saveEndpoint) {
                    alert('ä½ˆå±€å·²å„²å­˜ (Demo æ¨¡å¼ï¼šç„¡å¾Œç«¯è¨­å®šï¼Œåƒ…é¡¯ç¤ºæ–¼ Console ä¸¦æš«å­˜æ–¼è¨˜æ†¶é«”)ã€‚');
                }
            };

            document.getElementById('btn-load').onclick = async () => {
                if (lastSavedData) {
                    const result = await window.layout.load(lastSavedData);
                    updateStatusDisplay(window.layout);
                    
                    if (result.skipped && result.skipped.length > 0) {
                        alert(`ä½ˆå±€è®€å–æˆåŠŸï¼\n\næ³¨æ„ï¼šæ ¹æ“šã€Œåœ–ç‰‡ä¸é‡è¤‡é™åˆ¶ã€ï¼Œå·²è‡ªå‹•ç§»é™¤ ${result.skipped.length} å¼µé‡è¤‡çš„åœ–ç‰‡ã€‚\n(æª”å: ${result.skipped.join(', ')})`);
                    } else {
                        alert('ä½ˆå±€è®€å–æˆåŠŸï¼');
                    }
                } else {
                    alert('å°šæœªå„²å­˜ä»»ä½•ä½ˆå±€ï¼è«‹å…ˆè©¦è‘—æ“ºæ”¾åœ–ç‰‡ä¸¦å„²å­˜ã€‚');
                }
            };
        }

        init();
    </script>
</body>
</html>